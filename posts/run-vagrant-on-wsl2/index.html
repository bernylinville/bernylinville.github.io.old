<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=content-language content="en">
<meta name=color-scheme content="light dark">
<meta name=author content="Berny Linville">
<meta name=description content="Run Vagrant on Wsl2">
<meta name=keywords content="blog,developer,personal,sre">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="在 WSL2 上运行 Vagrant">
<meta name=twitter:description content="Run Vagrant on Wsl2">
<meta property="og:title" content="在 WSL2 上运行 Vagrant">
<meta property="og:description" content="Run Vagrant on Wsl2">
<meta property="og:type" content="article">
<meta property="og:url" content="https://devopsthink.org/posts/run-vagrant-on-wsl2/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-11-14T23:52:32+08:00">
<meta property="article:modified_time" content="2021-11-14T23:52:32+08:00">
<title>
在 WSL2 上运行 Vagrant · johndoe
</title>
<link rel=canonical href=https://devopsthink.org/posts/run-vagrant-on-wsl2/>
<link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin>
<link rel=stylesheet href=/css/coder.min.d9fddbffe6f27e69985dc5fe0471cdb0e57fbf4775714bc3d847accb08f4a1f6.css integrity="sha256-2f3b/+byfmmYXcX+BHHNsOV/v0d1cUvD2Eesywj0ofY=" crossorigin=anonymous media=screen>
<link rel=stylesheet href=/css/coder-dark.min.aa883b9ce35a8ff4a2a5008619005175e842bb18a8a9f9cc2bbcf44dab2d91fa.css integrity="sha256-qog7nONaj/SipQCGGQBRdehCuxioqfnMK7z0Tastkfo=" crossorigin=anonymous media=screen>
<link rel=icon type=image/png href=/img/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/img/favicon-16x16.png sizes=16x16>
<link rel=apple-touch-icon href=/images/apple-touch-icon.png>
<link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png>
<meta name=generator content="Hugo 0.89.2">
</head>
<body class="preload-transitions colorscheme-auto">
<div class=float-container>
<a id=dark-mode-toggle class=colorscheme-toggle>
<i class="fa fa-adjust fa-fw" aria-hidden=true></i>
</a>
</div>
<main class=wrapper>
<nav class=navigation>
<section class=container>
<a class=navigation-title href=/>
johndoe
</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle>
<i class="fa fa-bars fa-fw" aria-hidden=true></i>
</label>
<ul class=navigation-list>
<li class=navigation-item>
<a class=navigation-link href=/posts/>Blog</a>
</li>
<li class=navigation-item>
<a class=navigation-link href=/about/>About</a>
</li>
</ul>
</section>
</nav>
<div class=content>
<section class="container post">
<article>
<header>
<div class=post-title>
<h1 class=title>
<a class=title-link href=https://devopsthink.org/posts/run-vagrant-on-wsl2/>
在 WSL2 上运行 Vagrant
</a>
</h1>
</div>
<div class=post-meta>
<div class=date>
<span class=posted-on>
<i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2021-11-14T23:52:32+08:00>
November 14, 2021
</time>
</span>
<span class=reading-time>
<i class="fa fa-clock-o" aria-hidden=true></i>
4-minute read
</span>
</div>
</div>
</header>
<div>
<p>这篇文章记录了如何在 WSL 2 上安装使用 Vagrant，并且使用 VirtualBox 做为 provider。</p>
<h2 id=需求>
需求
<a class=heading-link href=#%e9%9c%80%e6%b1%82>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<ul>
<li>For x64 systems: <strong>Version 1903</strong> or higher, with <strong>Build 18362</strong> or higher.</li>
<li>For ARM64 systems: <strong>Version 2004</strong> or higher, with <strong>Build 19041</strong> or higher.</li>
<li><a href="https://link.zhihu.com/?target=https%3A//www.virtualbox.org/wiki/Downloads">VirtualBox</a></li>
</ul>
<h2 id=安装-wsl-2>
安装 WSL 2
<a class=heading-link href=#%e5%ae%89%e8%a3%85-wsl-2>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>参考官方文档安装 WSL 2，本文不提供说明 <a href=https://docs.microsoft.com/en-us/windows/wsl/install-win10>Install WSL on Windows 10​</a></p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>PS C:\Users&gt; wsl --list --verbose
  NAME      STATE           VERSION
* Ubuntu    Running         2

</code></pre></div><h2 id=安装-virtualbox>
安装 VirtualBox
<a class=heading-link href=#%e5%ae%89%e8%a3%85-virtualbox>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p><a href=https://www.virtualbox.org/wiki/Downloads>VirtualBox downloads</a></p>
<h2 id=安装-vagrant>
安装 Vagrant
<a class=heading-link href=#%e5%ae%89%e8%a3%85-vagrant>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=font-style:italic># 在 ubuntu 中运行：</span>
<span style=font-style:italic># https://www.vagrantup.com/downloads</span>
curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
sudo apt-add-repository <span style=font-style:italic>&#34;deb [arch=amd64] https://apt.releases.hashicorp.com </span><span style=font-weight:700>$(</span>lsb_release -cs<span style=font-weight:700>)</span><span style=font-style:italic> main&#34;</span>
sudo apt-get update &amp;&amp; sudo apt-get install vagrant

</code></pre></div><p>装完之后需要添加本地环境变量</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=font-style:italic># https://www.vagrantup.com/docs/other/wsl</span>
<span style=font-style:italic># 如果使用的不是 zsh 而是 bash，就添加到 bashrc</span>
echo <span style=font-style:italic>&#39;export VAGRANT_WSL_ENABLE_WINDOWS_ACCESS=&#34;1&#34;&#39;</span> &gt;&gt; ~/.zshrc
echo <span style=font-style:italic>&#39;export PATH=&#34;$PATH:/mnt/c/Program Files/Oracle/VirtualBox&#34;&#39;</span> &gt;&gt; ~/.zshrc

<span style=font-style:italic># 重新加载 zshrc</span>
source ~/.zshrc

</code></pre></div><h2 id=启动-vagrant>
启动 Vagrant
<a class=heading-link href=#%e5%90%af%e5%8a%a8-vagrant>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>由于 Windows 权限问题，Vagrant 目录只能放在 Windows 目录下</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cd /mnt/c/Users/name/
mkdir vagrant-demo
cd vagrant-demo

<span style=font-style:italic># 下载 box</span>
vagrant box add hashicorp/bionic64

<span style=font-style:italic># 初始化 `Vagrantfile`</span>
vagrant init hashicorp/bionic64

</code></pre></div><p>这时候如果直接 <code>vagrant up</code> 启动会报错，连接虚拟机超时，是因为默认转发 ssh 端口到 127.0.0.1:2222 ，而在 WSL 2 里面是无法访问到 Windows 主机 localhost。可以安装 <a href=https://github.com/Karandash8/virtualbox_WSL2>virtualbox_WSL2</a> 插件解决。</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>vagrant plugin install virtualbox_WSL2

</code></pre></div><p>装完之后启动 Vagrant</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>vagrant up

Bringing machine <span style=font-style:italic>&#39;default&#39;</span> up with <span style=font-style:italic>&#39;virtualbox&#39;</span> provider...
==&gt; default: Importing base box <span style=font-style:italic>&#39;hashicorp/bionic64&#39;</span>...
==&gt; default: Matching MAC address <span style=font-weight:700>for</span> NAT networking...
==&gt; default: Checking <span style=font-weight:700>if</span> box <span style=font-style:italic>&#39;hashicorp/bionic64&#39;</span> version <span style=font-style:italic>&#39;1.0.282&#39;</span> is up to date...
==&gt; default: Setting the name of the VM: vagrant-demo_default_1628143115787_58322
==&gt; default: Clearing any previously set network interfaces...
==&gt; default: Preparing network interfaces based on configuration...
    default: Adapter 1: nat
==&gt; default: Forwarding ports...
    default: 22 (guest) =&gt; 2222 (host) (adapter 1)
    default: 22 (guest) =&gt; 2222 (host) (adapter 1)
==&gt; default: Booting VM...
==&gt; default: Waiting <span style=font-weight:700>for</span> machine to boot. This may take a few minutes...
    default: SSH address: 172.17.96.1:2222
    default: SSH username: vagrant
    default: SSH auth method: private key
    default: Warning: Connection reset. Retrying...
    default:
    default: Vagrant insecure key detected. Vagrant will automatically replace
    default: this with a newly generated keypair <span style=font-weight:700>for</span> better security.
    default:
    default: Inserting generated public key within guest...
    default: Removing insecure key from the guest <span style=font-weight:700>if</span> it<span>&#39;</span>s present...
    default: Key inserted! Disconnecting and reconnecting using new SSH key...
==&gt; default: Machine booted and ready!
==&gt; default: Checking <span style=font-weight:700>for</span> guest additions in VM...
    default: The guest additions on this VM <span style=font-weight:700>do</span> not match the installed version of
    default: VirtualBox! In most cases this is fine, but in rare cases it can
    default: prevent things such as shared folders from working properly. If you see
    default: shared folder errors, please make sure the guest additions within the
    default: virtual machine match the version of VirtualBox you have installed on
    default: your host and reload your VM.
    default:
    default: Guest Additions Version: 6.0.10
    default: VirtualBox Version: 6.1
==&gt; default: Mounting shared folders...
    default: /vagrant =&gt; /mnt/c/Users/name/vagrant-demo

</code></pre></div><p>默认账户密码都是 vagrant</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>vagrant ssh
vagrant@172.17.96.1<span>&#39;</span>s password:
Welcome to Ubuntu 18.04.3 LTS (GNU/Linux 4.15.0-58-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Thu Aug  5 06:29:26 UTC 2021

  System load:  0.01              Processes:           89
  Usage of /:   2.5% of 61.80GB   Users logged in:     0
  Memory usage: 13%               IP address <span style=font-weight:700>for</span> eth0: 10.0.2.15
  Swap usage:   0%

 * Super-optimized <span style=font-weight:700>for</span> small spaces - read how we shrank the memory
   footprint of MicroK8s to make it the smallest full K8s around.

   https://ubuntu.com/blog/microk8s-memory-optimisation

 * Canonical Livepatch is available <span style=font-weight:700>for</span> installation.
   - Reduce system reboots and improve kernel security. Activate at:
     https://ubuntu.com/livepatch

0 packages can be updated.
0 updates are security updates.


vagrant@vagrant:~$

</code></pre></div><p>接下来就是结合 ansible 去做测试啦~</p>
<h2 id=待解决>
待解决
<a class=heading-link href=#%e5%be%85%e8%a7%a3%e5%86%b3>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<ul>
<li>centos/7 启动时会出现挂载文件夹出错</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>There was an error when attempting to rsync a synced folder.
Please inspect the error message below for more info.

Host path: /mnt/c/Users/name/vagrant-demo/
Guest path: /vagrant
Command: &#34;rsync&#34; &#34;--verbose&#34; &#34;--archive&#34; &#34;--delete&#34; &#34;-z&#34; &#34;--copy-links&#34; &#34;--no-owner&#34; &#34;--no-group&#34; &#34;--rsync-path&#34; &#34;sudo rsync&#34; &#34;-e&#34; &#34;ssh -p 2222 -o LogLevel=FATAL   -o ControlMaster=auto -o ControlPath=/tmp/vagrant-rsync-20210805-19044-ojcjma -o ControlPersist=10m  -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i &#39;/mnt/c/Users/name/vagrant-demo/.vagrant/machines/default/virtualbox/private_key&#39;&#34; &#34;--exclude&#34; &#34;.vagrant/&#34; &#34;/mnt/c/Users/name/vagrant-demo/&#34; &#34;vagrant@172.17.96.1:/vagrant&#34;
Error: vagrant@172.17.96.1: Permission denied (publickey,gssapi-keyex,gssapi-with-mic).
rsync: connection unexpectedly closed (0 bytes received so far) [sender]
rsync error: unexplained error (code 255) at io.c(235) [sender=3.1.3]

</code></pre></div><ul>
<li>
<p>使用 Docker 做为 provider</p>
</li>
<li>
<p><code>vagrant ssh</code> 没有自动调用密钥，而是需要输入密码</p>
</li>
</ul>
<h2 id=参考链接>
参考链接
<a class=heading-link href=#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p><a href=https://blog.thenets.org/how-to-run-vagrant-on-wsl-2/>how-to-run-vagrant-on-wsl-2</a></p>
<p><a href=https://stackoverflow.com/questions/65001570/connection-refused-in-vagrant-using-wsl-2>Connection Refused in Vagrant using WSL 2​</a></p>
</div>
<footer>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//yourdiscussshortname.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</footer>
</article>
</section>
</div>
<footer class=footer>
<section class=container>
©
2021
Berny Linville
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.
</section>
</footer>
</main>
<script src=/js/coder.min.03b17769f4f91ae35667e1f2a1ca8c16f50562576cf90ff32b3179926914daa5.js integrity="sha256-A7F3afT5GuNWZ+HyocqMFvUFYlds+Q/zKzF5kmkU2qU="></script>
</body>
</html>